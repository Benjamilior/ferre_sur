item_skus = {
    "Ferresurdotu1": "110308931",
    "Ferresurdotu2": "110307515",
    "Ferresurdotu4": "110312003",
    "Ferresurdotu5": "110329420",
    "Ferresurdotu7": "110330647",
    "Ferresurdotu8": "110590660",
    "Ferresurdotu9": "110305852",
    "Ferresurdotu11": "110311396",
    "Ferresurdotu18": "110302736",
    "Ferresurdotu21": "110273937",
    "Ferresurdotu22": "110306946",
    "Ferresurdotu23": "115419427",
    "Ferresurdotu27": "110272643",
    "Ferresurdotu31": "110328265",
    "Ferresurdotu33": "110299700",
    "Ferresurdotu34": "110310889",
    "Ferresurdotu35": "110391329",
    "Ferresurdotu36": "110328265",
    "Ferresurdotu38": "110325910",
    "Ferresurdotu39": "110326676",
    "Ferresurdotu40": "110283923",
    "Ferresurdotu41": "110285534",
    "Ferresurdotu42": "110298649",
    "Ferresurdotu47": "110290138",
    "Ferresurdotu48": "112823116",
    "Ferresurdotu50": "110275546",
    "Ferresurdotu52": "110241083",
    "Ferresurdotu53": "110287918",
    "Ferresurdotu56": "110309416",
    "Ferresurdotu57": "110272627",
    "Ferresurdotu59": "110317616",
    "Ferresurdotu61": "110391329",
    "Ferresurdotu62": "110221113",
    "Ferresurdotu64": "110328677",
    "Ferresurdotu67": "110248364",
    "Ferresurdotu68": "112857652",
    "Ferresurdotu69": "110327424",
    "Ferresurdotu70": "110288162",
    "Ferresurdotu72": "110319009",
    "Ferresurdotu73": "110259872",
    "Ferresurdotu74": "110313712",
    "Ferresurdotu76": "110284243",
    "Ferresurdotu77": "110293071",
    "Ferresurdotu78": "110217648",
    "Ferresurdotu80": "110512856",
    "Ferresurdotu82": "110287842",
    "Ferresurdotu83": "112823116",
    "Ferresurdotu86": "112877338",
    "Ferresurdotu87": "120406392",
    "Ferresurdotu89": "110299700",
    "Ferresurdotu90": "119464714",
    "Ferresurdotu92": "110314082",
    "Ferresurdotu93": "110326676",
    "Ferresurdotu94": "110307429",
    "Ferresurdotu95": "120519649",
    "Ferresurdotu97": "110298451",
    "Ferresurdotu98": "110300043",
    "Ferresurdotu102": "110248208",
    "Ferresurdotu105": "110248208",
    "Ferresurdotu108": "110307734",
    "Ferresurdotu110": "110311362",
    "Ferresurdotu112": "110261423",
    "Ferresurdotu113": "110287520",
    "Ferresurdotu116": "110284604",
    "Ferresurdotu119": "110315740",
    "Ferresurdotu120": "110269521",
    "Ferresurdotu121": "110262825",
    "Ferresurdotu122": "110391235",
    "Ferresurdotu123": "110305700",
    "Ferresurdotu124": "110312760",
    "Ferresurdotu126": "110287918",
    "Ferresurdotu127": "110300409",
    "Ferresurdotu130": "110300409",
    "Ferresurdotu132": "115973221",
    "Ferresurdotu133": "113771009",
    "Ferresurdotu135": "127889424",
    "Ferresurdotu136": "110316289",
    "Ferresurdotu137": "113853717",
    "Ferresurdotu138": "110284026",
    "Ferresurdotu139": "110282401",
    "Ferresurdotu140": "110328265",
    "Ferresurdotu141": "121614481",
    "Ferresurdotu143": "110242165",
    "Ferresurdotu145": "110245509",
    "Ferresurdotu146": "110244545",
    "Ferresurdotu147": "110250748",
    "Ferresurdotu148": "120521642",
    "Ferresurdotu149": "110254815",
    "Ferresurdotu150": "113876060",
    "Ferresurdotu153": "110232341",
    "Ferresurdotu155": "110324109",
    "Ferresurdotu157": "110245287",
    "Ferresurdotu159": "110284586",
    "Ferresurdotu160": "110263182",
    "Ferresurdotu163": "110051946",
    "Ferresurdotu167": "110290652",
    "Ferresurdotu176": "110288439",
    "Ferresurdotu178": "110273937",
    "Ferresurdotu180": "110309416",
    "Ferresurdotu181": "110148437",
    "Ferresurdotu182": "110220928",
    "Ferresurdotu184": "110318491",
    "Ferresurdotu186": "110267505",
    "Ferresurdotu188": "117147027",
    "Ferresurdotu189": "110300742",
    "Ferresurdotu195": "110278332",
    "Ferresurdotu196": "110218012",
    "Ferresurdotu201": "110254443",
    "Ferresurdotu207": "115757345",
    "Ferresurdotu208": "110235521",
    "Ferresurdotu210": "110308694",
    "Ferresurdotu212": "119515378",
    "Ferresurdotu215": "119515368",
    "Ferresurdotu216": "6634834",
    "Ferresurdotu219": "110322695",
    "Ferresurdotu220": "110276193",
    "Ferresurdotu223": "110279332",
    "Ferresurdotu224": "110310628",
    "Ferresurdotu227": "115694123",
    "Ferresurdotu230": "110288296",
    "Ferresurdotu233": "124010907",
    "Ferresurdotu234": "110326056",
    "Ferresurdotu236": "110220499",
    "Ferresurdotu238": "110289227",
    "Ferresurdotu239": "124114822",
    "Ferresurdotu243": "110254524",
    "Ferresurdotu245": "110294088",
    "Ferresurdotu250": "115973223",
    "Ferresurdotu252": "110287794",
    "Ferresurdotu253": "110326676",
    "Ferresurdotu254": "115387535",
    "Ferresurdotu255": "110327972",
    "Ferresurdotu256": "113843216",
    "Ferresurdotu257": "115885534",
    "Ferresurdotu258": "110216319",
    "Ferresurdotu259": "115755507",
    "Ferresurdotu264": "110250035",
    "Ferresurdotu266": "110257631",
    "Ferresurdotu269": "110306326",
    "Ferresurdotu270": "110239695",
    "Ferresurdotu271": "110324411",
    "Ferresurdotu272": "110323630",
    "Ferresurdotu275": "112710478",
    "Ferresurdotu278": "110261864",
    "Ferresurdotu279": "110274318",
    "Ferresurdotu280": "110297489",
    "Ferresurdotu282": "110297459",
    "Ferresurdotu284": "110239270",
    "Ferresurdotu285": "110313463",
    "Ferresurdotu290": "123028154",
    "Ferresurdotu291": "110232286",
    "Ferresurdotu292": "110221020",
    "Ferresurdotu293": "110325002",
    "Ferresurdotu294": "110245566",
    "Ferresurdotu295": "110183971",
    "Ferresurdotu297": "110257245",
    "Ferresurdotu298": "110219809",
    "Ferresurdotu299": "110275853",
    "Ferresurdotu302": "110273722",
    "Ferresurdotu303": "113201923",
    "Ferresurdotu304": "110235365",
    "Ferresurdotu305": "110271222",
    "Ferresurdotu306": "110057066",
    "Ferresurdotu307": "110219741",
    "Ferresurdotu313": "110300043",
    "Ferresurdotu316": "110217088",
    "Ferresurdotu317": "110290004",
    "Ferresurdotu318": "113770705",
    "Ferresurdotu320": "110292697",
    "Ferresurdotu322": "110219737",
    "Ferresurdotu324": "110280545",
    "Ferresurdotu326": "110234197",
    "Ferresurdotu328": "110312372",
    "Ferresurdotu329": "110217671",
    "Ferresurdotu327": "110152506",
    "Ferresurdotu332": "110230550",
    "Ferresurdotu337": "110304807",
    "Ferresurdotu339": "117302238",
    "Ferresurdotu345": "121698162",
    "Ferresurdotu346": "122734934",
    "Ferresurdotu352": "110298598",
    "Ferresurdotu353": "110298816",
    "Ferresurdotu355": "120485664",
    "Ferresurdotu358": "110237165",
    "Ferresurdotu359": "110256881",
    "Ferresurdotu360": "110266893",
    "Ferresurdotu361": "110312069",
    "Ferresurdotu364": "112673147",
    "Ferresurdotu365": "110220134",
    "Ferresurdotu367": "121235765",
    "Ferresurdotu368": "124308868",
    "Ferresurdotu369": "113219664",
    "Ferresurdotu371": "115653275",
    "Ferresurdotu384": "110269718",
    "Ferresurdotu386": "113813899",
    "Ferresurdotu391": "110240842",
    "Ferresurdotu394": "110261238",
    "Ferresurdotu395": "110271593",
    "Ferresurdotu397": "110232114",
    "Ferresurdotu399": "125113664",
    "Ferresurdotu400": "125113664",
    "Ferresurdotu401": "124397247",
    "Ferresurdotu402": "124397247",
    "Ferresurdotu406": "116112363",
    "Ferresurdotu407": "115304288",
    "Ferresurdotu410": "110150982",
    "Ferresurdotu411": "127662172",
    "Ferresurdotu412": "124397247",
    "Ferresurdotu413": "124397247",
    "Ferresurdotu414": "110244510",
    "Ferresurdotu416": "118086606",
    "Ferresurdotu421": "110286511",
    "Ferresurdotu423": "110231057",
    "Ferresurdotu427": "113359425",
    "Ferresurdotu429": "114111835",
    "Ferresurdotu430": "112742078",
    "Ferresurdotu436": "110233621",
    "Ferresurdotu437": "110259319",
    "Ferresurdotu438": "450006",
    "Ferresurdotu444": "115885534",
    "Ferresurdotu447": "129072723",
    "Ferresurdotu448": "113783107",
    "Ferresurdotu449": "110133268",
    "Ferresurdotu451": "110261405",
    "Ferresurdotu452": "121235797",
    "Ferresurdotu453": "124397247",
    "Ferresurdotu455": "121327266",
    "Ferresurdotu456": "110216640",
    "Ferresurdotu458": "110244588",
    "Ferresurdotu459": "110167898",
    "Ferresurdotu461": "115657164",
    "Ferresurdotu466": "126068457",
    "Ferresurdotu467": "112715103",
    "Ferresurdotu469": "122174041",
    "Ferresurdotu476": "115756885",
    "Ferresurdotu481": "112929957",
    "Ferresurdotu483": "110046960",
    "Ferresurdotu484": "113187560",
    "Ferresurdotu486": "110160646",
    "Ferresurdotu487": "110160646",
    "Ferresurdotu490": "114311995",
    "Ferresurdotu496": "110216655",
    "Ferresurdotu497": "110248364",
    "Ferresurdotu501": "110266859",
    "Ferresurdotu503": "110228759",
    "Ferresurdotu505": "110243994",
    "Ferresurdotu507": "110168955",
    "Ferresurdotu508": "110186033",
    "Ferresurdotu510": "110237559",
    "Ferresurdotu512": "110221991",
    "Ferresurdotu513": "110229486",
    "Ferresurdotu514": "125113664",
    "Ferresurdotu515": "110297189",
    "Ferresurdotu516": "121235813",
    "Ferresurdotu518": "110283890",
    "Ferresurdotu519": "113195852",
    "Ferresurdotu524": "110319167",
    "Ferresurdotu525": "115298784",
    "Ferresurdotu527": "120167449",
    "Ferresurdotu530": "115653275",
    "Ferresurdotu531": "110264745",
    "Ferresurdotu533": "110329670",
    "Ferresurdotu536": "110248973",
    "Ferresurdotu537": "110271760",
    "Ferresurdotu542": "110166909",
    "Ferresurdotu543": "110025461",
    "Ferresurdotu547": "110184299",
    "Ferresurdotu548": "110263657",
    "Ferresurdotu549": "110248973",
    "Ferresurdotu550": "110248364",
    "Ferresurdotu559": "110170583",
    "Ferresurdotu562": "110146400",
    "Ferresurdotu563": "110323704",
    "Ferresurdotu564": "110330428",
    "Ferresurdotu566": "110266893",
    "Ferresurdotu568": "110051946",
    "Ferresurdotu570": "110229486",
    "Ferresurdotu571": "110228713",
    "Ferresurdotu574": "110383619",
    "Ferresurdotu576": "116023428",
    "Ferresurdotu577": "110098777"
}
import requests
import json
import requests
#No olvidarse del key.json
#Buscar todos los "Cambiar" antes de usar
#En chatgpt cruzar sku_dotu con links. Pedir que te haga el json desde el info del sheets
import json
import time
import datetime
from selenium import webdriver
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.common.by import By
from selenium.common.exceptions import NoSuchElementException
from selenium.common.exceptions import StaleElementReferenceException

import pandas as pd

import gspread
from oauth2client.service_account import ServiceAccountCredentials
from google.oauth2.credentials import Credentials
from googleapiclient.discovery import build
from google.oauth2 import service_account

#Google Sheets
competitor = "Sodimac"  # Cambiar 
SCOPES = ['https://www.googleapis.com/auth/spreadsheets']
KEY = 'key.json' #Cambiar check
SPREADSHEET_ID = '1l2jZGmnAZN7Y8cELYIP_6eeKvBz9ivrJLgW5faYvMs0' #Cambiar check
creds = None
creds = service_account.Credentials.from_service_account_file(KEY, scopes=SCOPES)
service = build('sheets', 'v4', credentials=creds)
sheet = service.spreadsheets()


# PATH = "C:\\Program Files (x86)\\chromedriver.exe"
PATH = "/usr/local/bin/chromedriver"
# Configurar las opciones de Chrome
chrome_options = Options()
chrome_options.add_argument("--headless")  # Ver el Navegador
chrome_options.add_argument("--window-size=1920x1080")
start_time = time.time()  # Tiempo de inicio de la ejecución
driver = webdriver.Chrome(options=chrome_options)

url = "https://rcom.dynamicyield.com/v3/recommend/8772169"

# Define una lista de valores de SKU
sku_values = ["115419427", "110590660","110327424"]

# Define los headers
headers = {
    "cookie": "AWSALB=GVgX9M%2BF5bXaLT8Afc2Jr1zadpKxjngwCwDzp0x8qpdaNNQxr5519PDzmCq6w8LWm2TUunNRaOAfU6I%2FG2%2BiI%2Bl%2BCIyMxwZuzFhO3tjnCJTGvzCP4VP4CXFkVfMH; AWSALBCORS=GVgX9M%2BF5bXaLT8Afc2Jr1zadpKxjngwCwDzp0x8qpdaNNQxr5519PDzmCq6w8LWm2TUunNRaOAfU6I%2FG2%2BiI%2Bl%2BCIyMxwZuzFhO3tjnCJTGvzCP4VP4CXFkVfMH",
    "User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:124.0) Gecko/20100101 Firefox/124.0",
    "Accept": "*/*",
    "Accept-Language": "en-US,es-CL;q=0.7,en;q=0.3",
    "Accept-Encoding": "gzip, deflate, br",
    "Content-Type": "text/plain;charset=UTF-8",
    "Origin": "https://sodimac.falabella.com",
    "Connection": "keep-alive",
    "Referer": "https://sodimac.falabella.com/",
    "Sec-Fetch-Dest": "empty",
    "Sec-Fetch-Mode": "cors",
    "Sec-Fetch-Site": "cross-site",
    "TE": "trailers"
}
# Realiza la solicitud para cada par de SKU y ID de artículo en item_skus
price_data = []

for sku, item_id in item_skus.items():
    # Construye el payload usando el valor actual de item_id
    payload = {
        "data": [{
            "wId": 179696,
            "fId": 18853,
            "maxProducts": 50,
            "rules": [{
                "id": -1,
                "query": {
                    "conditions": [{
                        "field": "sku",
                        "arguments": [{
                            "action": "IS",
                            "value": item_id
                        }]
                    }]
                },
                "type": "include",
                "slots": []
            }, {
                "id": 901568,
                "type": "include",
                "slots": [],
                "isContextAware": False
            }],
            "filtering": []
        }],
        "ctx": {
            "type": "POST",
            "data": ["1"]
        },
        "geoLocation": {
            "geoCode": "CL",
            "geoRegionCode": "CL_RM"
        },
        "uid": "-5255700518632815596"
    }

    # Convierte el payload a formato JSON
    payload_json = json.dumps(payload)

    # Realiza la solicitud con el valor actual de item_id
    response = requests.request("POST", url, data=payload_json, headers=headers)

    # Carga la respuesta JSON en un diccionario
    response_data = response.json()

    # Obtiene la lista de productos recomendados de la respuesta
    recommended_products = response_data['response'][0]['slots']

    # Itera sobre cada producto recomendado e imprime los campos 'name', 'price' y 'dy_display_price'
    for product in recommended_products:
        sku = product['item']['sku']
        name = product['item']['name']
        price = product['item']['price']
        display_price = product['item']['dy_display_price']
        price_data.append({"SKU": sku, "Price": price, "Price_display": display_price})
    
    # price_data.append({
    #     'SKU': sku,
    #     'Name': name,
    #     'Price': price,
    #     'Display Price': display_price
    # })
       

# Continúa con el resto de tu código para actualizar Google Sheets

print(price_data)

df = pd.DataFrame(price_data)
                
end_time = time.time()  # Tiempo de finalización de la ejecución
execution_time = end_time - start_time
print("Tiempo de ejecución: %.2f segundos" % execution_time)


# Valores que se pasan a Sheets

values = [[item['SKU'],item['Price'],item['Price_display']] for item in price_data]
result = sheet.values().update(spreadsheetId=SPREADSHEET_ID,
                               range='sodimac!A2:C',  # CAMBIAR
                               valueInputOption='USER_ENTERED',
                               body={'values': values}).execute()
print("Datos insertados correctamente")


#Fecha de Extraccion

now = datetime.datetime.now()
now_str = now.strftime('%Y-%m-%d %H:%M:%S')
data = {"":now_str}
json_data = json.dumps(data)
values = [[json_data]]
result = sheet.values().update(spreadsheetId=SPREADSHEET_ID,
							range='sodimac!F2',#CAMBIAR
							valueInputOption='USER_ENTERED',
							body={'values':values}).execute()



# Obtener la última fila con datos en la nueva hoja
result = sheet.values().get(spreadsheetId="1ofzsOShcjwZn_lo_yvQhtteoUQfNxPfP8O-4wo-u1vo", range='ferre_sur!A:A').execute()
values = result.get('values', [])
values = [[row['SKU'], competitor, row['Price_display'], row['Price'], now_str] for _, row in df.iterrows()]
last_row = len(values) + 1  # Obtener el índice de la última fila vacía

# Insertar los resultados en la nueva hoja después de la última fila
update_range = f'ferre_sur!A{last_row}:E{last_row + len(values) - 1}'
result = sheet.values().update(
    spreadsheetId="1ofzsOShcjwZn_lo_yvQhtteoUQfNxPfP8O-4wo-u1vo",
    range=update_range,
    valueInputOption='USER_ENTERED',
    body={'values': values}
).execute()

print(f"Datos insertados correctamente en la nueva hoja de Google Sheets en el rango {update_range}")